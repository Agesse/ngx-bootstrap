name: on-release
on: release

env:
  NX_BRANCH: ${{ github.event.number }}
  NX_RUN_GROUP: ${{ github.run_id }}
  NX_CLOUD_AUTH_TOKEN: ${{ secrets.NX_CLOUD_AUTH_TOKEN }}
  MOZ_HEADLESS: 1
  GH_PAGES_URI: https://valorkin.github.io

jobs:
  # one run
  one_run:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}

  # install dependencies
  install:
    runs-on: ubuntu-latest
    needs: one_run
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/cache@v2.1.4
        id: cache
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-lock.json') }}
      - run: npm ci
        if: steps.cache.outputs.cache-hit != 'true'

  # build ngx-bootstrap
  build:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/cache@v2.1.4
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-lock.json') }}
      - uses: actions/cache@v2.1.4
        with:
          path: |
            dist
            node_modules/ngx-bootstrap
          key: dist-${{ github.run_id }}
      - run: npx ng build --runner cloud --prod --with-deps

  # publish to npm
  npm_publish:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/cache@v2.1.4
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-lock.json') }}
      - uses: actions/cache@v2.1.4
        with:
          path: |
            dist
            node_modules/ngx-bootstrap
          key: dist-${{ github.run_id }}
      - uses: JS-DevTools/npm-publish@v1
        with:
          package: "node_modules/ngx-bootstrap/package.json"
          token: ${{ secrets.NPM_TOKEN }}

  # update gh_pages
  gh_pages_deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/checkout@v2.3.4
        with:
          ref: 'gh-pages'
          path: 'gh-pages'

      - uses: actions/cache@v2.1.4
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('**/package-lock.json') }}
      - uses: actions/cache@v2.1.4
        with:
          path: |
            dist
            node_modules/ngx-bootstrap
          key: dist-${{ github.run_id }}

      #      - run: npm run scully
      - run: npx ts-node ./scripts/gh-pages-predeploy.ts
      - run: |
          cd gh-pages
          git config user.email "valorkin@gmail.com"
          git config user.name "ngx bootstrap ci"
          git add -A
          git commit -am "ci: gh-pages update"
        continue-on-error: true
      - name: push to gh-pages
        uses: ad-m/github-push-action@v0.6.0
        continue-on-error: true
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: 'gh-pages'
          directory: 'gh-pages'

  update_release_draft:
    needs: one_run
    runs-on: ubuntu-latest
    steps:
      # (Optional) GitHub Enterprise requires GHE_HOST variable set
      #- name: Set GHE_HOST
      #  run: |
      #    echo "GHE_HOST=${GITHUB_SERVER_URL##https:\/\/}" >> $GITHUB_ENV

      # Drafts your next Release notes as Pull Requests are merged into "master"
      - uses: release-drafter/release-drafter@v5
        # (Optional) specify config name to use, relative to .github/. Default: release-drafter.yml
        # with:
        #   config-name: my-config.yml
        #   disable-autolabeler: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
